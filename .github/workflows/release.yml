name: Build and Release with Maven

# 触发条件：推送 tag 时触发
on:
  push:
    tags:
      - 'v*'  # 匹配所有以 v 开头的 tag，例如 v1.0.0、v2.1.1-beta 等

# 关键：提升 GITHUB_TOKEN 的权限
permissions:
  contents: write  # 授予写入内容的权限，用于创建 Release 和上传资产

jobs:
  build-and-release:
    # 运行环境选择最新的 Ubuntu
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # 拉取完整历史，确保能获取到 tag 信息

      # 2. 设置 JDK 25 环境
      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'  # 使用 Eclipse Temurin 发行版（推荐）
          cache: 'maven'  # 缓存 Maven 依赖，加速构建

      # 3. 使用 Maven 打包（跳过测试可根据需要调整）
      - name: Build with Maven
        run: |
          ./mvnw -B clean package -DskipTests
          # 打印打包后的文件，方便调试
          ls -la Uniserv-app/target/

      # 4. 准备 Release 信息
      - name: Prepare release info
        id: release_info
        run: |
          # 获取 tag 名称作为 Release 标题
          echo "RELEASE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          # 获取项目版本号（从 pom.xml 中提取，可选）
          echo "PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_ENV

      # 5. 创建 GitHub Release 并上传打包产物
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # Release 标题
          name: Release ${{ env.RELEASE_TAG }}
          # Release 描述（可自定义，例如读取 CHANGELOG）
          body: |
            ## Release ${{ env.RELEASE_TAG }}
            - 基于 JDK 25 构建
            - 项目版本：${{ env.PROJECT_VERSION }}
          files: Uniserv-app/target/*.jar
        env:
          # 必须的环境变量，用于授权操作 GitHub Release
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}